<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Nur's Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        :root { --primary: #10b981; --dark: #111827; --light: #f3f4f6; }
        body { font-family: 'Poppins', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--dark); color: white; padding: 20px; display: flex; flex-direction: column; transition: 0.3s; z-index: 100; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: var(--primary); }
        .main { flex: 1; padding: 25px; overflow-y: auto; position: relative; }
        .header-mobile { display: none; background: var(--dark); color: white; padding: 15px; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 90; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 95; }
        .page-section { display: none; } .page-section.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, textarea, button { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; }
        #preview-img { max-width: 100%; height: 150px; object-fit: contain; display: none; margin-top: 10px; border: 1px solid #eee; }
        .progress-container { width: 100%; background: #eee; height: 8px; border-radius: 4px; display: none; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 4px; transition: 0.3s; }
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 200; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        @media (max-width: 768px) { .header-mobile { display: flex; } .sidebar { position: fixed; left: -260px; top: 0; height: 100%; } .sidebar.active { left: 0; } .overlay.active { display: block; } .main { padding-top: 80px; } }
    </style>
</head>
<body>
    <div id="toast-box"></div>
    <div id="auth-screen" style="position:fixed; inset:0; background:white; z-index:300; display:flex; align-items:center; justify-content:center;">
        <div style="width:300px; text-align:center;">
            <h2>Nur's Admin</h2>
            <input type="email" id="email" placeholder="Admin Email">
            <input type="password" id="pass" placeholder="Password">
            <button class="btn-primary" onclick="login()">Login</button>
        </div>
    </div>
    <div class="header-mobile"><h3>Nur's Library</h3><i class="fas fa-ellipsis-v" id="menu-btn"></i></div>
    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar">
        <h3 style="color:var(--primary)">Nur's Library</h3>
        <div class="nav-item active" onclick="switchPage('upload')"><i class="fas fa-plus"></i> Add Book</div>
        <div class="nav-item" onclick="switchPage('settings')"><i class="fas fa-cog"></i> Settings</div>
        <div class="nav-item" onclick="logout()" style="margin-top:auto; color:#ff4d4d;"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>
    <div class="main">
        <div id="page-upload" class="page-section active">
            <h2>Upload New Book</h2>
            <div class="card">
                <input type="text" id="b-title" placeholder="Book Title">
                <input type="text" id="b-author" placeholder="Author Name">
                <textarea id="b-desc" placeholder="Short Description"></textarea>
                <label>Banner Image (Preview):</label>
                <input type="file" id="b-banner" accept="image/*" onchange="previewImg(event)">
                <img id="preview-img">
                <label>PDF File (Upload to GitHub):</label>
                <input type="file" id="b-pdf" accept="application/pdf">
                <div class="progress-container" id="prog-cont"><div class="progress-fill" id="prog-bar"></div></div>
                <p id="prog-text" style="font-size:0.8rem; color:var(--primary); text-align:center;"></p>
                <button class="btn-primary" onclick="uploadBook()">Upload & Save to Database</button>
            </div>
            <h3>Book Database</h3>
            <div id="book-list"></div>
        </div>
        <div id="page-settings" class="page-section">
            <h2>GitHub Settings</h2>
            <div class="card">
                <input type="text" id="gh-owner" placeholder="GitHub Username">
                <input type="text" id="gh-repo" placeholder="Repo Name">
                <input type="password" id="gh-token" placeholder="GitHub Token">
                <button class="btn-primary" onclick="saveSettings()">Save Config</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDu8VDVXEbrLbqPmD24OPgNhbH5xjwi_vA",
            authDomain: "we4usnur.firebaseapp.com",
            projectId: "we4usnur",
            storageBucket: "we4usnur.firebasestorage.app",
            messagingSenderId: "1069907132834",
            appId: "1:1069907132834:web:f6aec92fc61c413767f2fb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        document.getElementById('menu-btn').onclick = () => { document.getElementById('sidebar').classList.add('active'); document.getElementById('overlay').classList.add('active'); };
        document.getElementById('overlay').onclick = () => { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); };

        function switchPage(p) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            if(p === 'settings') loadSettings();
        }

        function previewImg(e) {
            const img = document.getElementById('preview-img');
            img.src = URL.createObjectURL(e.target.files[0]); img.style.display = 'block';
        }

        function showToast(m) {
            const t = document.createElement('div'); t.className = 'toast'; t.innerText = m;
            document.getElementById('toast-box').appendChild(t); setTimeout(() => t.remove(), 3000);
        }

        auth.onAuthStateChanged(u => { document.getElementById('auth-screen').style.display = u ? 'none' : 'flex'; if(u) loadBooks(); });
        function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e => showToast(e.message)); }
        function logout() { auth.signOut(); }

        async function loadSettings() {
            const d = await db.collection('settings').doc('github').get();
            if(d.exists) { document.getElementById('gh-owner').value = d.data().owner; document.getElementById('gh-repo').value = d.data().repo; document.getElementById('gh-token').value = d.data().token; }
        }
        function saveSettings() {
            db.collection('settings').doc('github').set({ owner: document.getElementById('gh-owner').value, repo: document.getElementById('gh-repo').value, token: document.getElementById('gh-token').value, branch: 'main' }).then(() => showToast("Config Saved"));
        }

        async function uploadBook() {
            const title = document.getElementById('b-title').value, author = document.getElementById('b-author').value, desc = document.getElementById('b-desc').value, bFile = document.getElementById('b-banner').files[0], pFile = document.getElementById('b-pdf').files[0];
            if(!title || !pFile || !bFile) return showToast("Title, Banner and PDF required");
            
            const btn = document.querySelector('.btn-primary'); btn.disabled = true;
            document.getElementById('prog-cont').style.display = 'block';

            try {
                const confSnap = await db.collection('settings').doc('github').get();
                if(!confSnap.exists) throw new Error("GitHub Settings missing!");
                const conf = confSnap.data();

                const b64Banner = await toB64(bFile);
                const pdfData = await pFile.arrayBuffer();
                const pdfPages = (await pdfjsLib.getDocument(pdfData).promise).numPages;
                const pdfB64 = (await toB64(pFile)).split(',')[1];

                const fileName = `pdf/${Date.now()}_${pFile.name.replace(/\s/g, '_')}`;
                const apiUrl = `https://api.github.com/repos/${conf.owner}/${conf.repo}/contents/${fileName}`;

                const xhr = new XMLHttpRequest();
                xhr.open("PUT", apiUrl);
                xhr.setRequestHeader("Authorization", `token ${conf.token}`);
                xhr.upload.onprogress = (e) => { 
                    const p = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('prog-bar').style.width = p + "%";
                    document.getElementById('prog-text').innerText = p + "% Uploading...";
                };
                xhr.onload = async () => {
                    const pdfUrl = `https://raw.githubusercontent.com/${conf.owner}/${conf.repo}/main/${fileName}`;
                    // ডাটাবেসে সেভ হচ্ছে
                    await db.collection('books').add({ title, author, description: desc, banner: b64Banner, pdfUrl, pages: pdfPages, createdAt: new Date().toISOString() });
                    showToast("Uploaded Successfully!");
                    setTimeout(() => location.reload(), 1000);
                };
                xhr.send(JSON.stringify({ message: "Add PDF", content: pdfB64 }));
            } catch(e) { showToast(e.message); btn.disabled = false; }
        }

        function toB64(f) { return new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); }); }

        function loadBooks() {
            db.collection('books').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const l = document.getElementById('book-list'); l.innerHTML = '';
                snap.forEach(doc => {
                    l.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <span><b>${doc.data().title}</b></span>
                        <button onclick="db.collection('books').doc('${doc.id}').delete()" style="width:auto; background:red; color:white; border:none; padding:5px 10px; border-radius:5px;">Delete</button>
                    </div>`;
                });
            });
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
</body>
</html>

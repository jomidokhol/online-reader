<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Nur's Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background: #f3f4f6; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #111827; color: white; padding: 20px; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        
        .upload-box {
            border: 2px dashed #cbd5e1; padding: 30px; background: white; border-radius: 10px;
            text-align: center; margin-bottom: 20px;
        }
        input, button { padding: 10px; width: 100%; margin: 5px 0; border-radius: 5px; border: 1px solid #ddd; }
        .btn-primary { background: #10b981; color: white; border: none; cursor: pointer; }
        .btn-primary:hover { background: #059669; }

        /* Progress Bar */
        .progress-container { width: 100%; background: #e5e7eb; height: 10px; border-radius: 5px; margin-top: 10px; display: none; }
        .progress-fill { height: 100%; background: #10b981; width: 0%; border-radius: 5px; transition: width 0.2s; }
        .progress-text { font-size: 0.8rem; color: #10b981; text-align: right; }

        .book-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 99; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="auth-screen">
        <div style="width: 300px; text-align: center;">
            <h2>Admin Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <button class="btn-primary" onclick="login()">Login</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="sidebar">
        <h3>Nur's Library</h3>
        <p onclick="showSettings()" style="cursor:pointer"><i class="fas fa-cog"></i> GitHub Settings</p>
        <p onclick="logout()" style="cursor:pointer; margin-top: auto;"><i class="fas fa-sign-out-alt"></i> Logout</p>
    </div>

    <div class="main">
        <h2>Upload New Book</h2>
        <div class="upload-box">
            <input type="text" id="b-title" placeholder="Book Title">
            <input type="text" id="b-author" placeholder="Author Name">
            <p style="text-align:left; font-size:0.9rem; margin:5px 0;">Banner Image:</p>
            <input type="file" id="b-banner" accept="image/*">
            <p style="text-align:left; font-size:0.9rem; margin:5px 0;">PDF File:</p>
            <input type="file" id="b-pdf" accept="application/pdf">
            
            <!-- Progress Bar -->
            <div class="progress-container" id="prog-cont">
                <div class="progress-fill" id="prog-bar"></div>
            </div>
            <div class="progress-text" id="prog-text"></div>

            <button class="btn-primary" onclick="uploadBook()" style="margin-top: 15px;">Upload & Save</button>
        </div>

        <h3>Book List</h3>
        <div id="book-list"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDu8VDVXEbrLbqPmD24OPgNhbH5xjwi_vA",
            authDomain: "we4usnur.firebaseapp.com",
            projectId: "we4usnur",
            storageBucket: "we4usnur.firebasestorage.app",
            messagingSenderId: "1069907132834",
            appId: "1:1069907132834:web:f6aec92fc61c413767f2fb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Auth Logic
        auth.onAuthStateChanged(u => {
            document.getElementById('auth-screen').style.display = u ? 'none' : 'flex';
            if(u) loadBooks();
        });
        function login() {
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value)
                .catch(e => alert(e.message));
        }
        function logout() { auth.signOut(); }

        // PDF Helper: Count Pages & Convert Base64
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        async function getPdfInfo(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            return {
                pages: pdf.numPages,
                base64: await toBase64(file)
            };
        }

        function toBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        // Upload Logic
        async function uploadBook() {
            const title = document.getElementById('b-title').value;
            const author = document.getElementById('b-author').value;
            const bannerFile = document.getElementById('b-banner').files[0];
            const pdfFile = document.getElementById('b-pdf').files[0];

            if(!title || !pdfFile || !bannerFile) return alert("All fields required");

            const btn = document.querySelector('.btn-primary');
            const progCont = document.getElementById('prog-cont');
            const progBar = document.getElementById('prog-bar');
            const progText = document.getElementById('prog-text');

            btn.disabled = true;
            progCont.style.display = 'block';
            progText.innerText = "Processing File & Counting Pages...";

            try {
                // 1. Banner to Base64
                const bannerBase64 = await toBase64(bannerFile);

                // 2. PDF Info (Pages & Base64)
                const pdfInfo = await getPdfInfo(pdfFile);
                const pdfBase64Clean = pdfInfo.base64.split(',')[1];

                // 3. GitHub Upload with XHR for Progress
                const configDoc = await db.collection('settings').doc('github').get();
                if(!configDoc.exists) throw new Error("GitHub settings not found!");
                const config = configDoc.data();

                const fileName = `pdf/${Date.now()}_${pdfFile.name.replace(/\s/g, '_')}`; // Added pdf/ folder
                const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${fileName}`;

                progText.innerText = "Uploading to GitHub...";

                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open("PUT", url);
                    xhr.setRequestHeader("Authorization", `token ${config.token}`);
                    xhr.setRequestHeader("Content-Type", "application/json");

                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = (e.loaded / e.total) * 100;
                            progBar.style.width = percent + "%";
                            progText.innerText = `Uploading: ${Math.round(percent)}%`;
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) resolve(xhr.response);
                        else reject("GitHub Error: " + xhr.responseText);
                    };
                    xhr.onerror = () => reject("Network Error");

                    const data = JSON.stringify({
                        message: `Add book: ${title}`,
                        content: pdfBase64Clean,
                        branch: config.branch || 'main'
                    });
                    xhr.send(data);
                });

                // 4. Save to Firestore
                const rawUrl = `https://raw.githubusercontent.com/${config.owner}/${config.repo}/${config.branch || 'main'}/${fileName}`;
                
                await db.collection('books').add({
                    title, author, 
                    banner: bannerBase64,
                    pdfUrl: rawUrl,
                    pages: pdfInfo.pages, // Saving Page Count
                    createdAt: new Date().toISOString()
                });

                alert("Book Uploaded Successfully!");
                location.reload();

            } catch (err) {
                alert("Error: " + err);
                console.error(err);
            } finally {
                btn.disabled = false;
                progCont.style.display = 'none';
            }
        }

        // Settings Modal
        function showSettings() {
            const owner = prompt("GitHub Owner:");
            const repo = prompt("Repo Name:");
            const token = prompt("Personal Access Token:");
            if(owner && repo && token) {
                db.collection('settings').doc('github').set({ owner, repo, token, branch: 'main' });
            }
        }

        // List Books
        function loadBooks() {
            db.collection('books').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const list = document.getElementById('book-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const b = doc.data();
                    list.innerHTML += `
                    <div class="book-item">
                        <div>
                            <strong>${b.title}</strong> (${b.pages || '?'} pgs)<br>
                            <small>${b.author}</small>
                        </div>
                        <button onclick="db.collection('books').doc('${doc.id}').delete()" style="width:auto; background:red; color:white;">Delete</button>
                    </div>`;
                });
            });
        }
    </script>
</body>
</html>

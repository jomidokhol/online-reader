<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nur's Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        :root { --primary: #10b981; --bg: #f8fafc; --text: #334155; --card: #ffffff; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        nav { position: sticky; top: 0; z-index: 50; background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        .search-box { flex: 1; position: relative; }
        .search-box input { width: 100%; padding: 8px 35px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .card { background: var(--card); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-info { padding: 10px; font-size: 0.85rem; }
        .card-title { font-weight: 700; height: 35px; overflow: hidden; }
        #ad-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .ad-content { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 400px; }
        #timer { font-size: 3rem; font-weight: 800; color: var(--primary); margin: 15px; }
        #reader-modal { display: none; position: fixed; inset: 0; background: #1a1a1a; z-index: 500; flex-direction: column; }
        .toolbar { background: #2c2c2c; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; color: white; }
        #pdf-container { flex: 1; overflow: auto; display: flex; justify-content: center; padding: 10px; }
        canvas { max-width: 100%; box-shadow: 0 0 15px black; }
    </style>
</head>
<body>
    <nav>
        <div style="font-weight:800; color:var(--primary); font-size:1.2rem;">Nur's</div>
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search book...">
        </div>
    </nav>
    <div class="container">
        <div id="loading" style="text-align:center; padding: 50px;">Fetching Library...</div>
        <div class="book-grid" id="bookList"></div>
    </div>

    <!-- AD POPUP -->
    <div id="ad-modal">
        <div class="ad-content">
            <h3>Please Wait</h3>
            <div id="ad-box"></div>
            <div id="timer">10</div>
            <p>Your book is almost ready.</p>
        </div>
    </div>

    <!-- PDF READER -->
    <div id="reader-modal">
        <div class="toolbar">
            <i class="fas fa-arrow-left" onclick="history.back()" style="cursor:pointer"></i>
            <span id="pg-info">1 / --</span>
            <i class="fas fa-arrow-right" id="next" style="cursor:pointer"></i>
        </div>
        <div id="pdf-container"><canvas id="canvas"></canvas></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDu8VDVXEbrLbqPmD24OPgNhbH5xjwi_vA",
            authDomain: "we4usnur.firebaseapp.com",
            projectId: "we4usnur",
            storageBucket: "we4usnur.firebasestorage.app",
            messagingSenderId: "1069907132834",
            appId: "1:1069907132834:web:f6aec92fc61c413767f2fb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ডাটাবেস থেকে রিড করা হচ্ছে
        db.collection('books').orderBy('createdAt', 'desc').onSnapshot(snap => {
            document.getElementById('loading').style.display = 'none';
            const grid = document.getElementById('bookList'); grid.innerHTML = '';
            snap.forEach(doc => {
                const b = doc.data();
                grid.innerHTML += `<div class="card" onclick="startAd('${b.pdfUrl}')">
                    <img src="${b.banner}">
                    <div class="card-info">
                        <div class="card-title">${b.title}</div>
                        <small>${b.author} | ${b.pages} Pgs</small>
                    </div>
                </div>`;
            });
        });

        document.getElementById('searchInput').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('.card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(val) ? 'block' : 'none';
            });
        };

        let currentUrl = '', pdfDoc = null, pNum = 1;
        function startAd(url) {
            currentUrl = url; history.pushState({view: 'ad'}, '');
            document.getElementById('ad-modal').style.display = 'flex';
            
            // Ad Script Injection
            const adBox = document.getElementById('ad-box'); adBox.innerHTML = '';
            const sc = document.createElement('script'); sc.src = "https://pl28743379.effectivegatecpm.com/e8a4101484bcc312e8a1ce9f0d1eadac/invoke.js";
            sc.async = true; adBox.appendChild(sc);
            const div = document.createElement('div'); div.id = "container-e8a4101484bcc312e8a1ce9f0d1eadac"; adBox.appendChild(div);
            
            let time = 10;
            const itv = setInterval(() => {
                time--; document.getElementById('timer').innerText = time;
                if(time <= 0) { clearInterval(itv); document.getElementById('ad-modal').style.display = 'none'; openReader(); }
            }, 1000);

            window.onpopstate = () => {
                clearInterval(itv);
                document.getElementById('ad-modal').style.display = 'none';
                document.getElementById('reader-modal').style.display = 'none';
            };
        }

        async function openReader() {
            history.replaceState({view: 'reader'}, '');
            document.getElementById('reader-modal').style.display = 'flex';
            const loading = pdfjsLib.getDocument(currentUrl);
            pdfDoc = await loading.promise; pNum = 1; renderPage(1);
        }

        function renderPage(n) {
            pdfDoc.getPage(n).then(pg => {
                const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d'), vp = pg.getViewport({scale: 1.5});
                cvs.height = vp.height; cvs.width = vp.width;
                pg.render({canvasContext: ctx, viewport: vp});
                document.getElementById('pg-info').innerText = n + " / " + pdfDoc.numPages;
            });
        }

        document.getElementById('next').onclick = () => { if(pNum < pdfDoc.numPages) renderPage(++pNum); };
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
</body>
</html>
